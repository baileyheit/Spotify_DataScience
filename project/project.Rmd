---
title: "Project Proposal: What Makes a Song Popular on Spotify?"
author: "CCBK"
date: "3/21/18"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(infer)
library(broom)
```

```{r load-data}
songs <- read_csv("/cloud/project/data/songs.csv")
```


### Introduction

  The goal of our project is to determine the qualities of a song that influence popularity on Spotify. The dataset was retrieved online from kaggle.com. The data is derived from the Spotify Web API, which uses internal Spotify metrics to determine the parameters of the dataset. For subjective variables such as danceability and instrumentalness, the Spotify Web API utilizes Echo Nest algorithms. The dataset curator retrieved data for 228159 songs at random and aggregated this information into the dataset. Because the data set was so large and difficult to analyze in R-studio, a random sample of 5000 data points was taken and a new csv file was made.

  This project will analyze the variables of a song that correlate with a higher song popularity. To find this, we will assign song popularity as our dependent response variable and the other variables such as danceability, energy, and key as our predictor variables. Using backwards selection using multiple predictors models, we can determine which variables are the best predictors of a song's popularity score. Higher R^2 value for single predictors model or a higher adjusted R^2 value for multiple predictors can help us determine this. Visualizations will be used to show  general trends in popularity through various the qualitative and quantitative variables. Bootstraps and permutations will look at whether significant differences exist between certain variables as well as confidence intervals. These different statistical strategies all contribute to the research question of what qualities of a song contribute to its popularity. 

### Visualization

Relationship Between Different Variables and Song Popularity

```{r median-popularity-genre}
songs %>%
  group_by(genre) %>%
  summarise(medianpop = median(popularity)) %>%
  arrange(desc(medianpop))
```

```{r plot-selectedgenres-popularity}
songs_genre <- songs %>%
  filter(genre == "Pop"| genre == "Movie")

ggplot(data = songs_genre, mapping = aes(x = genre, y = popularity)) +
  geom_boxplot() +
  labs(title = "Comparing the Most Popular and Least Popular Genres", x = "Genres", y = "Popularity")
```


```{r plot-acousticness-popularity}
ggplot(data = songs, mapping = aes(x = acousticness, y = popularity, alpha = 0.005)) +
  geom_point() + 
  geom_smooth() +
  labs(title = "Acousticness v. Popularity of Songs", x = "Acousticness", y = "Popularity", alpha = "Transparency")
```


```{r plot-energy-popularity}
ggplot(data = songs, mapping = aes(x = energy, y = popularity, alpha = 0.0005)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Energy v. Popularity of Songs", x = "Energy", y = "Popularity", alpha = "Transparency")
```

```{r plot-danceability-popularity}
ggplot(data = songs, mapping = aes(x = danceability, y = popularity, alpha = 0.0005)) +
  geom_point() + 
  geom_smooth() +
  labs(title = "Danceability v. Popularity of Songs", x = "Danceability", y = "Popularity", alpha = "Transparency")
```

```{r plotg-duration-popularity}
songs_duration <- songs %>%
  mutate(duration_s = duration_ms/1000) %>%
  filter(duration_s <= 800)

ggplot(data = songs_duration, mapping = aes(x = duration_s, y = popularity, alpha = 0.0005)) +
  geom_point() + 
  geom_smooth() +
  labs(title = "Duration v. Popularity of Songs", x = "Duration", y = "Popularity", alpha = "Transparency")
```

```{r plot-instrumentalness-popularity}
ggplot(data = songs, mapping = aes(x = instrumentalness, y = popularity, alpha = 0.0005)) +
  geom_point() + 
  geom_smooth() +
  labs(title = "Instrumentalness v. Popularity of Songs", x = "Instrumentalness", y = "Popularity", alpha = "Transparency")
```


```{r plot-key-popularity}
ggplot(data = songs, mapping = aes(x = key, y = popularity)) +
  geom_boxplot() +
  labs(title = "Key v. Popularity of Songs", x = "Key", y = "Popularity")
```


```{r plot-liveness-popularity}
ggplot(data = songs, mapping = aes(x = liveness, y = popularity, alpha = 0.0005)) +
  geom_point() + 
  geom_smooth() +
  labs(title = "Liveness v. Popularity of Songs", x = "Liveness", y = "Popularity", alpha = "Transparency")
```

```{r plot-loudness-popularity}
songs_loudness <- songs %>%
  filter(loudness >= -30)

ggplot(data = songs_loudness, mapping = aes(x = loudness, y = popularity, alpha = 0.0005)) +
  geom_point() + 
  geom_smooth() +
  labs(title = "Loudness v. Popularity of Songs", x = "Loudness", y = "Popularity", alpha = "Transparency")
```

```{r plot-mode-popularity}
ggplot(data = songs, mapping = aes(x = mode, y = popularity)) +
  geom_boxplot() +
  labs(title = "Mode v. Popularity of Songs", x = "Mode", y = "Popularity")
```

```{r plot-speechiness-popularity}
ggplot(data = songs, mapping = aes(x = speechiness, y = popularity, alpha = 0.0005)) +
  geom_point() + 
  geom_smooth() +
  labs(title = "Speechiness v. Popularity of Songs", x = "Speechiness", y = "Popularity", alpha = "Transparency")
```

```{r plot-tempo-popularity}
ggplot(data = songs, mapping = aes(x = tempo, y = popularity, alpha = 0.0005)) +
  geom_point() + 
  geom_smooth() +
  labs(title = "Tempo v. Popularity of Songs", x = "Tempo", y = "Popularity", alpha = "Transparency")
```

```{r timesignature-popularity}
ggplot(data = songs, mapping = aes(x = time_signature, y = popularity)) +
  geom_boxplot() +
  labs(title = "Time Signature v. Popularity of Songs", x = "Time Signature", y = "Popularity", alpha = "Transparency")
```


```{r plot-valence-popularity}
ggplot(data = songs, mapping = aes(x = valence, y = popularity, alpha = 0.0005)) +
  geom_point() + 
  geom_smooth() +
  labs(title = "Valence v. Popularity of Songs", x = "Valence", y = "Popularity", alpha = "Transparency")
```



### Data Wrangling
### Linear Regression
```{r full-model}

full_model = lm(popularity ~ acousticness +
                  danceability +
                  energy +
                  instrumentalness +
                  liveness +
                  loudness +
                  speechiness + 
                  tempo + 
                  valence +
                  loudness * liveness,
                data = songs)

full_model

glance(full_model)$r.squared
glance(full_model)$adj.r.squared
```


```{r selected-model}

selected_model <- step(full_model, direction = "backward")

selected_model

glance(selected_model)$r.squared
glance(selected_model)$adj.r.squared
```

score_hat = 56.20 + -11.30 * acousticness + 17.19 * danceability - 5.933 * energy - 4.11 * instrumentalness + -6.40 * liveness + 0.60 * loudness + -10.36 * speechiness + -8.25 * valence + 0.62 * liveness:loudness

When all variables have a value of 0, then it is expected that a song's populariy is 56.20 One example of how a variable influences the popularity is with acousticness. If a song's acoustic score increases by 1 then popularity will on average decrease by 11.30 points, all else held constant. There is also an apparent interaction between danceability and energy. When the interaction increases by one on average the popularity decreases by 12.96 points, all else held constant. 

The adjusted R squared value for this model is 0.289, which means that roughly 28.9% of the variability in a song's popularity can be explained by the different variables in the multiple regression model. This indicates that there is a weak to moderate positive overall realtionship between a song's popularity and the different variables related to a song.


```{r mode-model}

mode_model = lm(popularity ~ mode, data = songs)

mode_model

glance(mode_model)$r.squared
```

score_hat = 43.77 + 2.007 * mode_minor

Minor equation: 
score_hat = 43.77 + 2.007 * 1 
          = 45.77

Major equestion:
score_hat = 43.77 + 2.007 * 0
          = 43.77
          
  Songs that are in the major mode tent to have higher popularity scores than songs in a minor key. All else held constant, theere is an expected popularity score increase of 2.007 if the song is in the minor key compared to the major key. 


```{r genre-model}

genre_model = lm(popularity ~ genre, data = songs)

genre_model

glance(genre_model)$r.squared
```

### Bootstrapping
```{r nrep}
nrep <- 1000
```


### Permutation Analysis
#### Popularity Difference Between Pop and Rap 

From the visualization of the popularity of songs with different genres, it was determined that Pop and Rap were the genres with the most popularity. As a result, we wanted to see if the difference in popularity between these two genres is significant. 

Null Hypothesis: There is not a difference between the mean popularities of songs that are pop and songs that are rap. 
Alternative Hypothesis: There is a difference between the mean popularities of songs that are pop and songs that are rap.

```{r observed-difference-pop}
songs_poprap <- songs%>%
  filter(genre=="Pop" | genre == "Rap")
mean_poprap <- songs_poprap %>%
  group_by(genre) %>%  
  summarise(samp_mean = mean(popularity)) %>%
  summarise(diff(samp_mean)) %>%
  pull()
mean_poprap
```

The observed difference between the mean popoularity of Pop and the mean popularity of Rap is 6.15. 

```{r null-dist-pop}
null_dist_poprap <- songs_poprap %>%
  specify(response = popularity, explanatory = genre) %>%
  hypothesize(null = "independence") %>%
  generate(reps = nrep, type = "permute") %>%
  calculate(stat = "diff in means", order = c("Pop", "Rap"))
ggplot(data = null_dist_poprap, aes(x = stat)) +
  geom_histogram(binwidth=.2) +
  geom_vline(xintercept = mean_poprap, color = "red") +
  geom_vline(xintercept = -1 * mean_poprap, color = "red") +
  labs(title = "Null distribution of differences in popularity means for pop or rap songs")
```

```{r p-value-pop}
null_dist_poprap %>%
  filter(stat <= mean_poprap) %>%
  summarise(pvalue = 2 * (n() / nrep))
```

The p-value of the difference between pop and rap songs is 0, which mean we can reject the null hypothesis that there is not a difference between the mean popularities of songs that are pop versus rap. The data provides convincing evidence that there is a difference in mean popularities of songs that in the pop genre versus the rap genre. 

#### Popularity Difference Between High Energy and Low Energy
From the visualizations, we saw that songs with more energy were more likely to have a greater popularity. We wanted to see if the difference in popularity between sonogs with high and low energy (defined as songs with energy at or above .5 and energy below .5 respectively) was significant. 

Null Hypothesis: There is not a difference between the mean popularities of songs that have high energy and low energy.
Alternative Hypothesis: There is a difference between the mean popularities of songs that have high energy and low energy.

```{r observed-difference-energy}
songs <- songs%>%
  mutate(energyLevel = case_when(
    energy >= .5 ~ "High",
    energy < .5 ~ "Low"
  ))
mean_energy <- songs %>%
  group_by(energyLevel) %>%  
  summarise(samp_mean = mean(popularity)) %>%
  summarise(diff(samp_mean)) %>%
  pull()
mean_energy
```
The observed mean popularity difference between songs with high and low energyy is 9.688. 

```{r null-dist-energy}
null_dist_energy <- songs %>%
  specify(response = popularity, explanatory = energyLevel) %>%
  hypothesize(null = "independence") %>%
  generate(reps = nrep, type = "permute") %>%
  calculate(stat = "diff in means", order = c("High", "Low"))
ggplot(data = null_dist_energy, aes(x = stat)) +
  geom_histogram(binwidth=.2) +
  geom_vline(xintercept = mean_energy, color = "red") +
  geom_vline(xintercept = -1 * mean_energy, color = "red") +
  labs(title = "Null distribution of differences in popularity means based on energy")
```

```{r p-value-energy}
null_dist_energy %>%
  filter(stat <= mean_energy) %>%
  summarise(pvalue = 2 * (n() / nrep))
```
The p-value of the difference between high and low energy is 0, which mean we can reject the null hypothesis that there is not a difference between the mean popularities of songs that have high energy and low energy. The data provides convincing evidence that there is a difference in mean popularities of songs that have high energy versus low energy. 

#### Popularity Difference Between High Danceability and Low Danceabililty
From the visualizations, we saw that songs with more danceability were more likely to have a greater popularity. We wanted to see if the difference in popularity between sonogs with high and low danceability (defined as songs with danceabililty at or above .5 and danceability below .5 respectively) was significant. 

Null Hypothesis: There is not a difference between the mean popularities of songs that have high danceability and low danceability
Alternative Hypothesis: There is a difference between the mean popularities of songs that have high danceability and low danceability

```{r observed-difference-dance}
songs <- songs%>%
  mutate(danceLevel = case_when(
    danceability >= .5 ~ "High",
    danceability < .5 ~ "Low"
  ))
mean_dance <- songs %>%
  group_by(danceLevel) %>%  
  summarise(samp_mean = mean(popularity)) %>%
  summarise(diff(samp_mean)) %>%
  pull()
mean_dance
```
The observed mean popularity difference between songs with high and low danceabiliity is 8.56. 

```{r null-dist-dance}
null_dist_dance <- songs %>%
  specify(response = popularity, explanatory = danceLevel) %>%
  hypothesize(null = "independence") %>%
  generate(reps = nrep, type = "permute") %>%
  calculate(stat = "diff in means", order = c("High", "Low"))
ggplot(data = null_dist_dance, aes(x = stat)) +
  geom_histogram(binwidth=.2) +
  geom_vline(xintercept = mean_dance, color = "red") +
  geom_vline(xintercept = -1 * mean_dance, color = "red") +
  labs(title = "Null distribution of differences in popularity means based on danceability")
```

```{r p-value-dance}
null_dist_dance %>%
  filter(stat <= mean_dance) %>%
  summarise(pvalue = 2 * (n() / nrep))
```

The p-value of the difference between high and low danceability is 0, which means we can reject the null hypothesis that there is not a difference between the mean popularities of songs that have high danceability and low danceability The data provides convincing evidence that there is a difference in mean popularities of songs that have high danceability versus low danceability 

#### Popularity Difference Between High Speechiness and Low Speechiness
From the visualizations, we saw that songs with more speechiness were more likely to have a greater popularity. We wanted to see if the difference in popularity between sonogs with high and low speechiness (defined as songs with speechiness at or above .5 and speechiness below .5 respectively) was significant. 

Null Hypothesis: There is not a difference between the mean popularities of songs that have high speechiness and low speechiness
Alternative Hypothesis: There is a difference between the mean popularities of songs that have high speechiness and low speechiness

```{r observed-difference-speech}
songs <- songs%>%
  mutate(speechLevel = case_when(
    speechiness >= .5 ~ "High",
    speechiness < .5 ~ "Low"
  ))
mean_speech <- songs %>%
  group_by(speechLevel) %>%  
  summarise(samp_mean = mean(popularity)) %>%
  summarise(diff(samp_mean)) %>%
  pull()
mean_speech
```
The observed mean popularity difference between songs with high and low speechiness is 23.09. 
```{r null-dist-speech}
null_dist_speech <- songs %>%
  specify(response = popularity, explanatory = speechLevel) %>%
  hypothesize(null = "independence") %>%
  generate(reps = nrep, type = "permute") %>%
  calculate(stat = "diff in means", order = c("High", "Low"))
ggplot(data = null_dist_speech, aes(x = stat)) +
  geom_histogram(binwidth=.2) +
  geom_vline(xintercept = mean_speech, color = "red") +
  geom_vline(xintercept = -1 * mean_speech, color = "red") +
  labs(title = "Null distribution of differences in popularity means based on speechiness")
```

The p-value of the difference between high and low speechiness is 0, which means we can reject the null hypothesis that there is not a difference between the mean popularities of songs that have high speechiness and low speechiness The data provides convincing evidence that there is a difference in mean popularities of songs that have high speechiness versus low speechiness. 

#### Popularity Difference Between High Valence and Low Valence
From the linear model, we saw that songs with less valence were more likely to have a greater popularity. We wanted to see if the difference in popularity between songs with high and low valence (defined as songs with valence at or above .5 and valence below .5 respectively) was significant. 

Null Hypothesis: There is not a difference between the mean popularities of songs that have high valence and low valence
Alternative Hypothesis: There is a difference between the mean popularities of songs that have high valence and low valence

```{r observed-difference-valence}
songs <- songs%>%
  mutate(valenceLevel = case_when(
    valence >= .5 ~ "High",
    valence < .5 ~ "Low"
  ))
mean_valence <- songs %>%
  group_by(valenceLevel) %>%  
  summarise(samp_mean = mean(popularity)) %>%
  summarise(diff(samp_mean)) %>%
  pull()
mean_valence
```
The observed difference in mean popularity between songs with high and low valence is 2.12. 

```{r null-dist-valence}
null_dist_valence <- songs %>%
  specify(response = popularity, explanatory = valenceLevel) %>%
  hypothesize(null = "independence") %>%
  generate(reps = nrep, type = "permute") %>%
  calculate(stat = "diff in means", order = c("High", "Low"))
ggplot(data = null_dist_valence, aes(x = stat)) +
  geom_histogram(binwidth=.2) +
  geom_vline(xintercept = mean_valence, color = "red") +
  geom_vline(xintercept = -1 * mean_valence, color = "red") +
  labs(title = "Null distribution of differences in popularity means based on speechiness")
```

```{r p-value-valence}
null_dist_valence %>%
  filter(stat <= mean_valence) %>%
  summarise(pvalue = 2 * (n() / nrep))
```

The p-value of the difference between high and low valence is 0, which means we can reject the null hypothesis that there is not a difference between the mean popularities of songs that have high valence and low valence. The data provides convincing evidence that there is a difference in mean popularities of songs that have high valence versus low valence. 

#### Popularity Difference Between Major and Minor
We wanted to see if the difference in popularity between songs in a major or minor mode was significant. 

Null Hypothesis: There is not a difference between the mean popularities of songs that are in a major mode versus minor mode.
Alternative Hypothesis: There is a difference between the mean popularities of songs that are in a major mode versus minor mode.

```{r observed-difference-mode}
mean_mode <- songs %>%
  group_by(mode) %>%  
  summarise(samp_mean = mean(popularity)) %>%
  summarise(diff(samp_mean)) %>%
  pull()
mean_mode
```
The observed mean popularity difference between major and minor songs is 2.03.
```{r null-dist-mode}
null_dist_mode <- songs %>%
  specify(response = popularity, explanatory = mode) %>%
  hypothesize(null = "independence") %>%
  generate(reps = nrep, type = "permute") %>%
  calculate(stat = "diff in means", order = c("Major", "Minor"))
ggplot(data = null_dist_mode, aes(x = stat)) +
  geom_histogram(binwidth=.2) +
  geom_vline(xintercept = mean_mode, color = "red") +
  geom_vline(xintercept = -1 * mean_mode, color = "red") +
  labs(title = "Null distribution of differences in popularity means based on mode")
```

```{r p-value-mode}
null_dist_mode %>%
  filter(stat >= mean_mode) %>%
  summarise(pvalue = 2 * (n() / nrep))
```

The p-value of the difference between major and minor is 0, which means we can reject the null hypothesis that there is not a difference between the mean popularities of songs that are in a major or minor mode. The data provides convincing evidence that there is a difference in mean popularities of songs that are in a major mode versus a minor mode.  

### Conclusion

Your project goes here! Before you submit, make sure your chunks are turned off with `echo = FALSE`. 

You can add sections as you see fit. Make sure you have a section called Introduction at the beginning and a section called Conclusion at the end. The rest is up to you!